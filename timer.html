<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポモドーロタイマー</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body class="timer-window">
    <div class="timer-display" id="timer-display">25:00</div>
    <div class="timer-label" id="timer-label">作業時間</div>
    
    <div class="timer-controls">
        <button class="timer-control-btn" id="start-btn">開始</button>
        <button class="timer-control-btn" id="pause-btn" style="display: none;">一時停止</button>
        <button class="timer-control-btn" id="reset-btn">リセット</button>
    </div>

    <script>
        class PomodoroTimer {
            constructor() {
                this.workDuration = 25 * 60; // seconds
                this.breakDuration = 5 * 60; // seconds
                this.currentTime = this.workDuration;
                this.isRunning = false;
                this.isBreakTime = false;
                this.interval = null;
                this.isVerticalMode = window.location.search.includes('vertical=true');
                
                this.initializeElements();
                this.bindEvents();
                this.updateDisplay();
                this.listenForMessages();
                this.applyVerticalStyles();
                this.requestNotificationPermission();
            }
            
            requestNotificationPermission() {
                // ページ読み込み時に通知の許可を求める
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            initializeElements() {
                this.display = document.getElementById('timer-display');
                this.label = document.getElementById('timer-label');
                this.startBtn = document.getElementById('start-btn');
                this.pauseBtn = document.getElementById('pause-btn');
                this.resetBtn = document.getElementById('reset-btn');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.start());
                this.pauseBtn.addEventListener('click', () => this.pause());
                this.resetBtn.addEventListener('click', () => this.reset());
                
                // Fullscreen on double click
                document.body.addEventListener('dblclick', () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log('Fullscreen request failed:', err);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                });
            }

            listenForMessages() {
                window.addEventListener('message', (event) => {
                    if (event.data.action === 'updateSettings') {
                        this.workDuration = event.data.data.workDuration * 60;
                        this.breakDuration = event.data.data.breakDuration * 60;
                        if (!this.isRunning) {
                            this.reset();
                        }
                    } else if (event.data.action === 'requestFullscreen') {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log('Fullscreen request failed:', err);
                        });
                    } else if (event.data.action === 'setVerticalMode') {
                        this.isVerticalMode = true;
                        this.applyVerticalStyles();
                    }
                });
            }
            
            applyVerticalStyles() {
                if (this.isVerticalMode) {
                    // 縦型ディスプレイ用のスタイル調整
                    this.display.style.fontSize = '25vh';
                    this.label.style.fontSize = '5vh';
                    document.querySelector('.timer-controls').style.flexDirection = 'column';
                    document.querySelector('.timer-controls').style.width = '80%';
                    
                    const buttons = document.querySelectorAll('.timer-control-btn');
                    buttons.forEach(btn => {
                        btn.style.width = '100%';
                        btn.style.fontSize = '3vh';
                        btn.style.padding = '3vh 5vh';
                    });
                }
            }

            start() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.startBtn.style.display = 'none';
                    this.pauseBtn.style.display = 'block';
                    
                    this.interval = setInterval(() => this.tick(), 1000);
                }
            }

            pause() {
                if (this.isRunning) {
                    this.isRunning = false;
                    this.pauseBtn.style.display = 'none';
                    this.startBtn.style.display = 'block';
                    
                    if (this.interval) {
                        clearInterval(this.interval);
                        this.interval = null;
                    }
                }
            }

            reset() {
                this.pause();
                this.isBreakTime = false;
                this.currentTime = this.workDuration;
                this.label.textContent = '作業時間';
                this.updateDisplay();
                this.updateBackgroundColor();
            }

            tick() {
                this.currentTime--;
                
                if (this.currentTime < 0) {
                    this.switchMode();
                } else {
                    this.updateDisplay();
                }
            }

            switchMode() {
                this.isBreakTime = !this.isBreakTime;
                
                if (this.isBreakTime) {
                    this.currentTime = this.breakDuration;
                    this.label.textContent = '休憩時間';
                    this.playNotification();
                } else {
                    this.currentTime = this.workDuration;
                    this.label.textContent = '作業時間';
                    this.playNotification();
                }
                
                this.updateBackgroundColor();
                this.updateDisplay();
            }

            updateDisplay() {
                const minutes = Math.floor(this.currentTime / 60);
                const seconds = this.currentTime % 60;
                this.display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updateBackgroundColor() {
                if (this.isBreakTime) {
                    document.body.style.background = 'linear-gradient(135deg, #52c41a 0%, #73d13d 100%)';
                } else {
                    document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }

            playNotification() {
                // 3回ビープ音を鳴らす
                const playBeep = (frequency, delay) => {
                    setTimeout(() => {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // 作業終了時は高い音、休憩終了時は低い音
                        oscillator.frequency.value = frequency;
                        oscillator.type = 'sine';
                        
                        // 音量を上げて、より長く鳴らす
                        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.8);
                    }, delay);
                };
                
                // 作業終了時と休憩終了時で異なる音を鳴らす
                const baseFrequency = this.isBreakTime ? 600 : 1000;
                
                // 3回鳴らす（0ms, 1000ms, 2000ms後）
                playBeep(baseFrequency, 0);
                playBeep(baseFrequency * 1.2, 1000);
                playBeep(baseFrequency * 1.5, 2000);
                
                // ブラウザの通知APIも使用（許可が必要）
                if ('Notification' in window && Notification.permission === 'granted') {
                    const message = this.isBreakTime ? '休憩時間です！' : '作業時間です！';
                    new Notification('ポモドーロタイマー', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">⏰</text></svg>'
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }
        }

        // Initialize timer when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new PomodoroTimer();
        });
    </script>
</body>
</html>